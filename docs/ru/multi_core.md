# Многоядерная архитектура (Multiprocessing)

В `khorsyio` реализована поддержка многоядерного выполнения задач на базе стандартных процессов Python (`multiprocessing`).

## Почему Multiprocessing?
Мы отказались от изолированных субинтерпретаторов в пользу процессов по следующим причинам:
1. **Истинная параллельность**: Каждый процесс имеет собственный GIL, что позволяет использовать 100% мощности каждого ядра CPU.
2. **Совместимость**: Полная поддержка `msgspec`, C-расширений, пулов соединений с БД и сетевых библиотек.
3. **Изоляция**: Падение одного воркера не влияет на стабильность основного приложения или других воркеров.

## Как это работает
Архитектура состоит из трех уровней:

1. **Supervisor (Bus)**: Основной процесс управляет пулом воркеров (`ProcessPool`).
2. **Шина обмена (Pipe)**: Сообщения передаются через системные пайпы. Сериализация выполняется через `msgspec.msgpack`, что обеспечивает максимальную скорость при сохранении типизации.
3. **Workers**: Изолированные процессы, которые динамически загружают нужные обработчики и выполняют их в собственном `asyncio` цикле.

## Режимы выполнения
Режим настраивается в классе обработчика:
- `execution_mode = "main"` (по умолчанию) — выполнение в основном цикле (для I/O задач).
- `execution_mode = "process"` — выполнение в отдельном процессе из пула (для CPU-bound задач).

## Пример использования
```python
class HeavyHandler(Handler):
    subscribes_to = "heavy.task"
    publishes = "heavy.result"
    execution_mode = "process"  # Включаем многоядерность

    async def process(self, data: TaskData, ctx: Context) -> TaskResult:
        # Тяжелые вычисления теперь не блокируют основной Bus
        result = some_heavy_math(data.n)
        return TaskResult(value=result)
```
